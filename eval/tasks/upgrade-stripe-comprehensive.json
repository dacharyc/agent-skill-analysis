{
  "skill_name": "upgrade-stripe-comprehensive",
  "tasks": [
    {
      "id": "upgrade-stripe-comprehensive-01",
      "type": "direct_target",
      "prompt": "Write a Python module that initializes a Stripe client pinned to the 2026-01-28.clover API version, creates a customer with email and metadata, then creates a subscription for that customer with a price ID. Include proper error handling with Stripe exceptions.",
      "target_language": "python",
      "codebase_variant": "python_sync",
      "expected_patterns": [
        "StripeClient",
        "stripe\\.api_version",
        "v1\\.customers\\.create|client\\.customers\\.create",
        "v1\\.subscriptions\\.create|client\\.subscriptions\\.create",
        "stripe\\.StripeError|stripe\\.CardError|stripe\\.InvalidRequestError"
      ],
      "anti_patterns": [
        "require\\(['\"]stripe['\"]\\)",
        "Stripe\\.api_version\\s*=",
        "apiVersion:",
        "const stripe",
        "Stripe::Customer"
      ],
      "pattern_sources": [
        {
          "url": "https://docs.stripe.com/api/customers/create.md?lang=python",
          "description": "Stripe Python customer creation - source of StripeClient, client.v1.customers.create() patterns"
        },
        {
          "url": "https://docs.stripe.com/api/subscriptions/create.md?lang=python",
          "description": "Stripe Python subscription creation - source of client.v1.subscriptions.create() patterns"
        },
        {
          "url": "https://docs.stripe.com/api/versioning.md?lang=python",
          "description": "Stripe API versioning - source of stripe.api_version property assignment pattern"
        },
        {
          "url": "https://docs.stripe.com/error-handling.md?lang=python",
          "description": "Stripe Python error handling - source of stripe.StripeError, stripe.CardError, stripe.InvalidRequestError exception patterns"
        },
        {
          "url": "https://docs.stripe.com/api/customers/create.md?lang=node",
          "description": "Anti-patterns: Node.js require('stripe'), apiVersion property, const stripe"
        },
        {
          "url": "https://docs.python.org/3/reference/simple_stmts.html#import",
          "description": "Python import statement - source of import keyword for importing stripe module"
        },
        {
          "url": "https://docs.stripe.com/api/customers/create.md?lang=ruby",
          "description": "Anti-patterns: Ruby Stripe::Customer and Stripe.api_version patterns"
        }
      ],
      "notes": "Direct Python task matching skill's primary Python examples. Anti-patterns detect Ruby (Stripe.api_version, Stripe::Customer) or JavaScript (require/const/apiVersion) bleed from the skill's multi-language examples."
    },
    {
      "id": "upgrade-stripe-comprehensive-02",
      "type": "cross_language",
      "prompt": "Write a Go function that initializes a Stripe client, retrieves a customer by ID, and updates their default payment method. Use the official stripe-go library with proper API version handling.",
      "target_language": "go",
      "expected_patterns": [
        "github\\.com/stripe/stripe-go",
        "stripe\\.Key\\s*=",
        "customer\\.Get\\(",
        "func\\s+\\w+\\("
      ],
      "anti_patterns": [
        "stripe\\.api_version",
        "require\\(['\"]stripe['\"]\\)",
        "Stripe\\.api_version",
        "apiVersion:",
        "stripe_version="
      ],
      "pattern_sources": [
        {
          "url": "https://raw.githubusercontent.com/stripe/stripe-go/refs/heads/master/README.md",
          "description": "Go stripe-go README: import path github.com/stripe/stripe-go/v84, stripe.Key assignment pattern, customer.Get() usage examples"
        },
        {
          "url": "https://raw.githubusercontent.com/stripe/stripe-go/refs/heads/master/customer/client.go",
          "description": "Go stripe-go customer package: customer.Get(id, params) method signature and implementation"
        },
        {
          "url": "https://docs.stripe.com/api/customers/retrieve?lang=python",
          "description": "Anti-patterns: Python stripe.api_version, stripe_version= parameter"
        },
        {
          "url": "https://docs.stripe.com/api/customers/retrieve?lang=node",
          "description": "Anti-patterns: Node.js require('stripe'), apiVersion property"
        },
        {
          "url": "https://go.dev/doc/code",
          "description": "Go documentation - source of func keyword for defining Go functions"
        },
        {
          "url": "https://docs.stripe.com/api/customers/retrieve?lang=ruby",
          "description": "Anti-patterns: Ruby Stripe.api_version assignment"
        }
      ],
      "notes": "Go is a strongly-typed language mentioned in the skill (should NOT set API version directly), but no Go code examples are provided. Tests whether Python/Ruby/JS API version patterns bleed into Go output, which the skill explicitly says to avoid for strongly-typed languages."
    },
    {
      "id": "upgrade-stripe-comprehensive-03",
      "type": "similar_syntax",
      "prompt": "Write a Node.js Express middleware that initializes Stripe with explicit API versioning, verifies incoming webhook signatures using the raw request body, and dispatches events to handler functions based on event type.",
      "target_language": "javascript",
      "expected_patterns": [
        "require\\(['\"]stripe['\"]\\)",
        "apiVersion:\\s*['\"]",
        "stripe\\.webhooks\\.constructEvent",
        "req\\.body",
        "module\\.exports|export"
      ],
      "anti_patterns": [
        "stripe\\.api_version\\s*=",
        "stripe_version=",
        "Stripe\\.api_version",
        "import stripe",
        "Stripe::Webhook"
      ],
      "pattern_sources": [
        {
          "url": "https://raw.githubusercontent.com/stripe/stripe-node/refs/heads/master/README.md",
          "description": "Node.js Stripe initialization: require('stripe') pattern, apiVersion constructor option, import/export patterns"
        },
        {
          "url": "https://docs.stripe.com/webhooks.md?lang=node",
          "description": "Node.js webhook handling: stripe.webhooks.constructEvent for signature verification, req.body usage with express.raw middleware"
        },
        {
          "url": "https://docs.stripe.com/api?lang=python",
          "description": "Anti-patterns: Python stripe.api_version= assignment and import stripe"
        },
        {
          "url": "https://nodejs.org/api/modules.html",
          "description": "Node.js modules - source of require() function and module.exports pattern for Node.js modules"
        },
        {
          "url": "https://docs.stripe.com/webhooks?lang=ruby",
          "description": "Anti-patterns: Ruby Stripe::Webhook.construct_event pattern"
        }
      ],
      "notes": "JavaScript is in the skill with code examples. Tests whether Python's stripe.api_version= or Ruby's Stripe::Webhook patterns contaminate JS webhook code. JS uses apiVersion in constructor, not assignment."
    },
    {
      "id": "upgrade-stripe-comprehensive-04",
      "type": "grounded",
      "prompt": "Given the following existing payment integration code, upgrade it from Stripe API version 2024-12-18.acacia to 2026-01-28.clover. Update the API version, replace any deprecated patterns, and ensure the Stripe.js script tag uses the correct version.\n\n```python\nimport stripe\n\nstripe.api_key = 'sk_test_xxx'\nstripe.api_version = '2024-12-18.acacia'\n\ndef create_checkout_session(price_id, success_url, cancel_url):\n    session = stripe.checkout.Session.create(\n        mode='subscription',\n        line_items=[{'price': price_id, 'quantity': 1}],\n        success_url=success_url,\n        cancel_url=cancel_url,\n    )\n    return session\n```\n\n```html\n<script src=\"https://js.stripe.com/basil/stripe.js\"></script>\n```",
      "target_language": "python",
      "expected_patterns": [
        "2026-01-28\\.clover",
        "stripe\\.api_version\\s*=\\s*['\"]2026-01-28\\.clover['\"]",
        "js\\.stripe\\.com/clover/stripe\\.js"
      ],
      "anti_patterns": [
        "2024-12-18\\.acacia",
        "basil",
        "require\\(['\"]stripe['\"]\\)",
        "Stripe\\.api_version"
      ],
      "pattern_sources": [
        {
          "url": "https://docs.stripe.com/api/versioning.md?lang=python",
          "description": "Stripe API versioning: specifies '2026-01-28.clover' as the current version string, stripe.api_version assignment pattern"
        },
        {
          "url": "https://docs.stripe.com/js",
          "description": "Stripe.js script tag: js.stripe.com/clover/stripe.js URL pattern with version-based path"
        },
        {
          "url": "https://docs.stripe.com/api?lang=node",
          "description": "Anti-patterns: Node.js require('stripe') pattern"
        },
        {
          "url": "https://docs.stripe.com/api?lang=ruby",
          "description": "Anti-patterns: Ruby Stripe.api_version pattern"
        }
      ],
      "notes": "Grounded task with real code context. Tests correct version upgrade knowledge (acacia->clover, basil->clover for Stripe.js). Anti-patterns ensure old version strings are replaced and no cross-language contamination occurs."
    },
    {
      "id": "upgrade-stripe-comprehensive-05",
      "type": "adjacent_domain",
      "prompt": "Write a Ruby service class that handles Stripe webhook events for subscription lifecycle changes (customer.subscription.created, customer.subscription.updated, customer.subscription.deleted). Parse the event, verify the signature, and update a local database record accordingly.",
      "target_language": "ruby",
      "expected_patterns": [
        "Stripe::Webhook\\.construct_event",
        "class\\s+\\w+",
        "customer\\.subscription\\.",
        "def\\s+\\w+"
      ],
      "anti_patterns": [
        "stripe\\.webhooks\\.constructEvent",
        "stripe\\.api_version\\s*=",
        "const stripe",
        "import stripe"
      ],
      "pattern_sources": [
        {
          "url": "https://docs.stripe.com/webhooks.md?lang=ruby",
          "description": "Ruby webhook handling: Stripe::Webhook.construct_event for signature verification, event.type handling with case statements, subscription event examples (customer.subscription.created)"
        },
        {
          "url": "https://docs.stripe.com/api/events.md?lang=ruby",
          "description": "Ruby event types: subscription lifecycle events (customer.subscription.created, customer.subscription.updated, customer.subscription.deleted)"
        },
        {
          "url": "https://docs.stripe.com/webhooks.md?lang=node",
          "description": "Anti-patterns: Node.js stripe.webhooks.constructEvent pattern"
        },
        {
          "url": "https://ruby-doc.org/3.3.6/syntax/modules_and_classes_rdoc.html",
          "description": "Ruby classes - source of class keyword for defining Ruby service classes"
        },
        {
          "url": "https://ruby-doc.org/3.3.6/syntax/methods_rdoc.html",
          "description": "Ruby methods - source of def keyword for defining methods in Ruby classes"
        },
        {
          "url": "https://docs.stripe.com/api?lang=python",
          "description": "Anti-patterns: Python import stripe and stripe.api_version= patterns"
        }
      ],
      "notes": "Ruby is in the skill but webhook handling is adjacent to the upgrade focus. Tests whether JavaScript webhook patterns (stripe.webhooks.constructEvent) bleed into Ruby output. Ruby uses Stripe::Webhook.construct_event."
    },
    {
      "id": "upgrade-stripe-comprehensive-06",
      "type": "grounded",
      "prompt": "Given the following legacy payment integration, upgrade it to use the new StripeClient pattern with proper API versioning. Preserve the same business logic.\n\n```python\nimport stripe\n\nstripe.api_key = 'sk_test_xxx'\nstripe.api_version = '2024-12-18.acacia'\n\ndef charge_customer(customer_id, amount_cents, currency='usd'):\n    intent = stripe.PaymentIntent.create(\n        amount=amount_cents,\n        currency=currency,\n        customer=customer_id,\n        payment_method_types=['card'],\n        confirm=True,\n        off_session=True,\n    )\n    return intent\n\ndef refund_payment(payment_intent_id, amount_cents=None):\n    params = {'payment_intent': payment_intent_id}\n    if amount_cents:\n        params['amount'] = amount_cents\n    return stripe.Refund.create(**params)\n```",
      "target_language": "python",
      "expected_patterns": [
        "StripeClient",
        "2026-01-28\\.clover",
        "payment_intents\\.create|v1\\.payment_intents\\.create",
        "refunds\\.create|v1\\.refunds\\.create"
      ],
      "anti_patterns": [
        "stripe\\.PaymentIntent\\.create",
        "stripe\\.Refund\\.create",
        "2024-12-18\\.acacia",
        "require\\(['\"]stripe['\"]\\)",
        "Stripe::PaymentIntent"
      ],
      "pattern_sources": [
        {
          "url": "https://docs.stripe.com/api/payment_intents/create?lang=python",
          "description": "Python PaymentIntent creation: new StripeClient pattern uses client.v1.payment_intents.create(params={...})"
        },
        {
          "url": "https://docs.stripe.com/api/refunds/create?lang=python",
          "description": "Python Refund creation: new pattern uses client.v1.refunds.create(params={...})"
        },
        {
          "url": "https://github.com/stripe/stripe-python/wiki/Migration-guide-for-v8-(StripeClient)",
          "description": "StripeClient migration guide: old stripe.PaymentIntent.create() → new client.v1.payment_intents.create()"
        },
        {
          "url": "https://docs.stripe.com/api/payment_intents/create?lang=ruby",
          "description": "Anti-patterns: Ruby Stripe::PaymentIntent.create pattern"
        }
      ],
      "notes": "PARTIAL OUT-OF-BAND: PaymentIntent appears in comprehensive references (Python: client.v1.payment_intents.retrieve with expand, Go: PaymentIntentParams, Ruby: payment_intents.retrieve) but only in retrieve/expand examples — not create. Refund API is not covered in any reference. Targeted reference has zero PaymentIntent coverage. Tests whether comprehensive's incidental PaymentIntent mentions help with the create/refund migration vs targeted which must rely entirely on pretrained knowledge."
    },
    {
      "id": "upgrade-stripe-comprehensive-07",
      "type": "adjacent_domain",
      "prompt": "Write a Node.js module that creates a Stripe Connect Express account for a marketplace seller, requests card_payments and transfers capabilities, then generates an onboarding link for the account. Use the current Stripe API version.",
      "target_language": "javascript",
      "expected_patterns": [
        "accounts\\.create",
        "capabilities",
        "card_payments",
        "transfers",
        "requested:\\s*true",
        "accountLinks\\.create|account_links\\.create"
      ],
      "anti_patterns": [
        "stripe\\.api_version\\s*=",
        "import stripe",
        "Stripe::Account",
        "stripe\\.Account\\.create",
        "create_account"
      ],
      "pattern_sources": [
        {
          "url": "https://docs.stripe.com/api/accounts/create?lang=node",
          "description": "Node.js Connect account creation: stripe.accounts.create() with capabilities object, controller settings"
        },
        {
          "url": "https://docs.stripe.com/api/account_links/create?lang=node",
          "description": "Node.js account link creation: stripe.accountLinks.create() for onboarding URL generation"
        },
        {
          "url": "https://docs.stripe.com/connect/express-accounts",
          "description": "Express account setup: capabilities structure with {requested: true} pattern"
        },
        {
          "url": "https://docs.stripe.com/api/accounts/create?lang=python",
          "description": "Anti-patterns: Python stripe.Account.create pattern"
        },
        {
          "url": "https://docs.stripe.com/api/accounts/create?lang=ruby",
          "description": "Anti-patterns: Ruby Stripe::Account.create pattern"
        }
      ],
      "notes": "OUT-OF-BAND: Tests Connect account creation — comprehensive references mention 'stripe_account' as a request option (for acting on behalf of connected accounts) but contain no account creation, capabilities, or onboarding link APIs. Targeted reference has zero Connect coverage. This is the purest out-of-band test — all three variants are essentially equally uncovered for the actual task."
    },
    {
      "id": "upgrade-stripe-comprehensive-08",
      "type": "adjacent_domain",
      "prompt": "Write a Ruby class that records usage-based billing meter events for an AI API product. The class should accept a customer ID and token count, create a Stripe meter event with the event name 'api_tokens_used', and handle errors gracefully. Use the current Stripe API version.",
      "target_language": "ruby",
      "expected_patterns": [
        "Stripe::Billing::MeterEvent",
        "event_name",
        "api_tokens_used",
        "payload",
        "stripe_customer_id",
        "class\\s+\\w+"
      ],
      "anti_patterns": [
        "stripe\\.billing\\.meter_events",
        "stripe\\.billing\\.meterEvents",
        "Billing::MeterEvent\\.create\\(",
        "import stripe",
        "const stripe",
        "create_usage_record"
      ],
      "pattern_sources": [
        {
          "url": "https://docs.stripe.com/api/billing/meter-event/create?lang=ruby",
          "description": "Ruby meter event creation: Stripe::Billing::MeterEvent.create() with event_name, payload hash"
        },
        {
          "url": "https://docs.stripe.com/billing/subscriptions/usage-based/recording-usage-api",
          "description": "Usage-based billing: meter event structure with event_name, payload containing stripe_customer_id and value"
        },
        {
          "url": "https://docs.stripe.com/api/billing/meter-event/create?lang=python",
          "description": "Anti-patterns: Python stripe.billing.MeterEvent.create() or stripe.billing.meter_events.create()"
        },
        {
          "url": "https://docs.stripe.com/api/billing/meter-event/create?lang=node",
          "description": "Anti-patterns: Node.js stripe.billing.meterEvents.create() camelCase pattern"
        }
      ],
      "notes": "OUT-OF-BAND: Tests Billing Meter Events API — not covered by any reference file. Meter events are a newer Stripe API surface (v2 billing). Tests whether the model fabricates the meter event API structure or falls back to the deprecated UsageRecord pattern, and whether Python/Node.js naming conventions contaminate Ruby output."
    }
  ]
}
